// Sistema de Gestão de Faturamento e ROI
// Produção (Vercel): PostgreSQL. Local: use PostgreSQL (Docker, Neon, Supabase) ou SQLite (ver README).

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Usuários: autenticação por usuário/senha (AUTH_MODE=users)
model User {
  id           String    @id @default(cuid())
  username     String    @unique
  passwordHash String    @map("password_hash")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  sessions    Session[]
  operations  Operation[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  tokenHash String   @unique @map("token_hash")
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

// Operação: unidade central do sistema (cada negócio/linha independente). Pertence a um usuário.
model Operation {
  id                 String   @id @default(cuid())
  name               String
  dailyBudget         Float    @map("daily_budget")
  pixAccount         String   @map("pix_account")
  expenseCategories   String?  @map("expense_categories") // JSON: [{ id, label }]
  userId             String?  @map("user_id")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  user         User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  dailyEntries DailyEntry[]

  @@index([userId])
  @@map("operations")
}

// Lançamento diário: agrupa gastos e receitas por dia e operação
model DailyEntry {
  id           String   @id @default(cuid())
  date         DateTime
  operationId  String   @map("operation_id")
  observations String?

  operation Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)
  expenses  Expense[]
  revenues  Revenue[]

  @@unique([operationId, date])
  @@index([operationId])
  @@index([date])
  @@map("daily_entries")
}

// Categorias de gasto: ADS, IA, CHIPS, VARIAVEL
// SQLite não suporta enum - usamos String
// Gasto: pode ser diário ou mensal (rateado)
model Expense {
  id            String         @id @default(cuid())
  dailyEntryId  String         @map("daily_entry_id")
  category      String         // ADS | IA | CHIPS | VARIAVEL
  amount        Float
  description   String?
  isMonthly     Boolean        @default(false) @map("is_monthly")
  manualAdjust  Float?         @map("manual_adjust")
  createdAt     DateTime       @default(now()) @map("created_at")

  dailyEntry DailyEntry @relation(fields: [dailyEntryId], references: [id], onDelete: Cascade)

  @@index([dailyEntryId])
  @@map("expenses")
}

// Receita: sempre via PIX
model Revenue {
  id           String   @id @default(cuid())
  dailyEntryId String   @map("daily_entry_id")
  amount       Float
  description  String?
  time         String?  // Horário opcional no formato HH:mm
  createdAt    DateTime @default(now()) @map("created_at")

  dailyEntry DailyEntry @relation(fields: [dailyEntryId], references: [id], onDelete: Cascade)

  @@index([dailyEntryId])
  @@map("revenues")
}
